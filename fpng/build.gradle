plugins {
    id 'cpp-library'
}

group = 'com.manticore.tools'
version = '1.0.6-SNAPSHOT'

repositories {
    mavenCentral()
}

library {
    linkage = [Linkage.STATIC, Linkage.SHARED]
    targetMachines = [
            machines.linux.x86_64,
            machines.windows.x86, machines.windows.x86_64,
            machines.macOS.x86_64
    ]
}

// PGO Prepare
// -fprofile-dir=/data/pgo -fprofile-generate=/data/pgo

// PGO Apply
// -fprofile-dir=/data/pgo -fprofile-use=/data/pgo -fprofile-correction

tasks.withType(CppCompile).configureEach {
    //compilerArgs = ['-fPIC',  '-O3', '-march=native', '-funroll-loops', '-std=c++17', '-Wall', '-msse4.2', '-mpclmul', '-msse2', '-fno-strict-aliasing', '-fprofile-dir=data/pgo', '-fprofile-generate=data/pgo']
    //compilerArgs = ['-fPIC',  '-O3', '-march=native', '-funroll-loops', '-std=c++17', '-Wall', '-msse4.2', '-mpclmul', '-msse2', '-fno-strict-aliasing', '-fprofile-dir=data/pgo', '-fprofile-use=data/pgo', '-fprofile-correction']
    compilerArgs = ['-fPIC',  '-O3', '-march=native', '-funroll-loops', '-std=c++17', '-Wall', '-msse4.2', '-mpclmul', '-msse2', '-mavx', '-fno-strict-aliasing' ]
    debuggable = false
    optimized = true
}

tasks.withType(LinkSharedLibrary).configureEach {
    linkerArgs = ['-lgcov', '--coverage']
}

tasks.register('copyNativeLib', Copy) {
    dependsOn assemble
    from './build/lib/main/debug/shared'
    from './build/lib/main/release/shared'
    into '../fpng-java/build/resources/main/lib'

    // the native library file extensions on different platforms
    include '**/*.dll', '**/*.so', 'build/lib/**/*.dylib'
}

